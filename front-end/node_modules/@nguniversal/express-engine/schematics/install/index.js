(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("@nguniversal/express-engine/schematics/install/index", ["require", "exports", "@angular-devkit/core", "@angular-devkit/schematics", "@angular-devkit/schematics/tasks", "@schematics/angular/utility/config", "@schematics/angular/utility/dependencies", "@schematics/angular/utility/project", "@schematics/angular/utility/project-targets", "@schematics/angular/utility/ast-utils", "typescript", "@nguniversal/express-engine/schematics/install/utils", "@schematics/angular/utility/workspace"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    /**
     * @license
     * Copyright Google LLC All Rights Reserved.
     *
     * Use of this source code is governed by an MIT-style license that can be
     * found in the LICENSE file at https://angular.io/license
     */
    const core_1 = require("@angular-devkit/core");
    const schematics_1 = require("@angular-devkit/schematics");
    const tasks_1 = require("@angular-devkit/schematics/tasks");
    const config_1 = require("@schematics/angular/utility/config");
    const dependencies_1 = require("@schematics/angular/utility/dependencies");
    const project_1 = require("@schematics/angular/utility/project");
    const project_targets_1 = require("@schematics/angular/utility/project-targets");
    const ast_utils_1 = require("@schematics/angular/utility/ast-utils");
    const ts = require("typescript");
    const utils_1 = require("@nguniversal/express-engine/schematics/install/utils");
    const workspace_1 = require("@schematics/angular/utility/workspace");
    // TODO(CaerusKaru): make these configurable
    const BROWSER_DIST = 'dist/browser';
    const SERVER_DIST = 'dist/server';
    function getClientProject(host, options) {
        const workspace = config_1.getWorkspace(host);
        const clientProject = workspace.projects[options.clientProject];
        if (!clientProject) {
            throw new schematics_1.SchematicsException(`Client app ${options.clientProject} not found.`);
        }
        return clientProject;
    }
    function addDependenciesAndScripts(options) {
        return (host) => {
            dependencies_1.addPackageJsonDependency(host, {
                type: dependencies_1.NodeDependencyType.Default,
                name: '@nguniversal/express-engine',
                version: '8.1.1',
            });
            dependencies_1.addPackageJsonDependency(host, {
                type: dependencies_1.NodeDependencyType.Default,
                name: '@nguniversal/module-map-ngfactory-loader',
                version: '8.1.1',
            });
            dependencies_1.addPackageJsonDependency(host, {
                type: dependencies_1.NodeDependencyType.Default,
                name: 'express',
                version: '^4.15.2',
            });
            if (options.webpack) {
                dependencies_1.addPackageJsonDependency(host, {
                    type: dependencies_1.NodeDependencyType.Dev,
                    name: 'ts-loader',
                    version: '^5.2.0',
                });
                dependencies_1.addPackageJsonDependency(host, {
                    type: dependencies_1.NodeDependencyType.Dev,
                    name: 'webpack-cli',
                    version: '^3.1.0',
                });
            }
            const serverFileName = options.serverFileName.replace('.ts', '');
            const pkgPath = '/package.json';
            const buffer = host.read(pkgPath);
            if (buffer === null) {
                throw new schematics_1.SchematicsException('Could not find package.json');
            }
            const pkg = JSON.parse(buffer.toString());
            pkg.scripts['compile:server'] = options.webpack ?
                'webpack --config webpack.server.config.js --progress --colors' :
                `tsc -p ${serverFileName}.tsconfig.json`;
            pkg.scripts['serve:ssr'] = `node dist/${serverFileName}`;
            pkg.scripts['build:ssr'] = 'npm run build:client-and-server-bundles && npm run compile:server';
            pkg.scripts['build:client-and-server-bundles'] =
                // tslint:disable:max-line-length
                `ng build --prod && ng run ${options.clientProject}:server:production --bundleDependencies all`;
            host.overwrite(pkgPath, JSON.stringify(pkg, null, 2));
            return host;
        };
    }
    function updateConfigFile(options) {
        return workspace_1.updateWorkspace((workspace => {
            const clientProject = workspace.projects.get(options.clientProject);
            if (clientProject) {
                const buildTarget = clientProject.targets.get('build');
                const serverTarget = clientProject.targets.get('server');
                // We have to check if the project config has a server target, because
                // if the Universal step in this schematic isn't run, it can't be guaranteed
                // to exist
                if (!serverTarget || !buildTarget) {
                    return;
                }
                serverTarget.options = Object.assign({}, serverTarget.options, { outputPath: SERVER_DIST });
                buildTarget.options = Object.assign({}, buildTarget.options, { outputPath: BROWSER_DIST });
            }
        }));
    }
    function addModuleMapLoader(options) {
        return (host) => {
            const clientProject = project_1.getProject(host, options.clientProject);
            const clientTargets = project_targets_1.getProjectTargets(clientProject);
            if (!clientTargets.server) {
                // If they skipped Universal schematics and don't have a server target,
                // just get out
                return;
            }
            const mainPath = core_1.normalize('/' + clientTargets.server.options.main);
            const appServerModuleRelativePath = utils_1.findAppServerModulePath(host, mainPath);
            const modulePath = core_1.normalize(`/${clientProject.root}/src/${appServerModuleRelativePath}.ts`);
            // Add the module map loader import
            let moduleSource = utils_1.getTsSourceFile(host, modulePath);
            const importModule = 'ModuleMapLoaderModule';
            const importPath = '@nguniversal/module-map-ngfactory-loader';
            const moduleMapImportChange = ast_utils_1.insertImport(moduleSource, modulePath, importModule, importPath);
            if (moduleMapImportChange) {
                const recorder = host.beginUpdate(modulePath);
                recorder.insertLeft(moduleMapImportChange.pos, moduleMapImportChange.toAdd);
                host.commitUpdate(recorder);
            }
            // Add the module map loader module to the imports
            const importText = 'ModuleMapLoaderModule';
            moduleSource = utils_1.getTsSourceFile(host, modulePath);
            const metadataChanges = ast_utils_1.addSymbolToNgModuleMetadata(moduleSource, modulePath, 'imports', importText);
            if (metadataChanges) {
                const recorder = host.beginUpdate(modulePath);
                metadataChanges.forEach((change) => {
                    recorder.insertRight(change.pos, change.toAdd);
                });
                host.commitUpdate(recorder);
            }
        };
    }
    function addExports(options) {
        return (host) => {
            const clientProject = project_1.getProject(host, options.clientProject);
            const clientTargets = project_targets_1.getProjectTargets(clientProject);
            if (!clientTargets.server) {
                // If they skipped Universal schematics and don't have a server target,
                // just get out
                return;
            }
            const mainPath = core_1.normalize('/' + clientTargets.server.options.main);
            const mainSourceFile = utils_1.getTsSourceFile(host, mainPath);
            let mainText = utils_1.getTsSourceText(host, mainPath);
            const mainRecorder = host.beginUpdate(mainPath);
            const expressEngineExport = utils_1.generateExport(mainSourceFile, ['ngExpressEngine'], '@nguniversal/express-engine');
            const moduleMapExport = utils_1.generateExport(mainSourceFile, ['provideModuleMap'], '@nguniversal/module-map-ngfactory-loader');
            const exports = ast_utils_1.findNodes(mainSourceFile, ts.SyntaxKind.ExportDeclaration);
            const addedExports = `\n${expressEngineExport}\n${moduleMapExport}\n`;
            const exportChange = ast_utils_1.insertAfterLastOccurrence(exports, addedExports, mainText, 0);
            mainRecorder.insertLeft(exportChange.pos, exportChange.toAdd);
            host.commitUpdate(mainRecorder);
        };
    }
    function default_1(options) {
        return (host, context) => {
            const clientProject = getClientProject(host, options);
            if (clientProject.projectType !== 'application') {
                throw new schematics_1.SchematicsException(`Universal requires a project type of "application".`);
            }
            if (!options.skipInstall) {
                context.addTask(new tasks_1.NodePackageInstallTask());
            }
            const rootSource = schematics_1.apply(schematics_1.url('./files/root'), [
                options.skipServer ? schematics_1.filter(path => !path.startsWith('__serverFileName')) : schematics_1.noop(),
                options.webpack ?
                    schematics_1.filter(path => !path.includes('tsconfig')) : schematics_1.filter(path => !path.startsWith('webpack')),
                schematics_1.template(Object.assign({}, core_1.strings, options, { stripTsExtension: (s) => s.replace(/\.ts$/, ''), getBrowserDistDirectory: () => BROWSER_DIST, getServerDistDirectory: () => SERVER_DIST }))
            ]);
            return schematics_1.chain([
                options.skipUniversal ?
                    schematics_1.noop() : schematics_1.externalSchematic('@schematics/angular', 'universal', options),
                updateConfigFile(options),
                schematics_1.mergeWith(rootSource),
                addDependenciesAndScripts(options),
                addModuleMapLoader(options),
                addExports(options),
            ]);
        };
    }
    exports.default = default_1;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9tb2R1bGVzL2V4cHJlc3MtZW5naW5lL3NjaGVtYXRpY3MvaW5zdGFsbC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztJQUFBOzs7Ozs7T0FNRztJQUNILCtDQUFzRTtJQUN0RSwyREFhb0M7SUFDcEMsNERBQXdFO0lBQ3hFLCtEQUFnRTtJQUVoRSwyRUFHa0Q7SUFDbEQsaUVBQStEO0lBQy9ELGlGQUE4RTtJQUU5RSxxRUFLK0M7SUFDL0MsaUNBQWlDO0lBQ2pDLGdGQUFrRztJQUNsRyxxRUFBc0U7SUFFdEUsNENBQTRDO0lBQzVDLE1BQU0sWUFBWSxHQUFHLGNBQWMsQ0FBQztJQUNwQyxNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUM7SUFFbEMsU0FBUyxnQkFBZ0IsQ0FDdkIsSUFBVSxFQUFFLE9BQXlCO1FBRXJDLE1BQU0sU0FBUyxHQUFHLHFCQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckMsTUFBTSxhQUFhLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUNsQixNQUFNLElBQUksZ0NBQW1CLENBQUMsY0FBYyxPQUFPLENBQUMsYUFBYSxhQUFhLENBQUMsQ0FBQztTQUNqRjtRQUVELE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxTQUFTLHlCQUF5QixDQUFDLE9BQXlCO1FBQzFELE9BQU8sQ0FBQyxJQUFVLEVBQUUsRUFBRTtZQUNwQix1Q0FBd0IsQ0FBQyxJQUFJLEVBQUU7Z0JBQzdCLElBQUksRUFBRSxpQ0FBa0IsQ0FBQyxPQUFPO2dCQUNoQyxJQUFJLEVBQUUsNkJBQTZCO2dCQUNuQyxPQUFPLEVBQUUsbUJBQW1CO2FBQzdCLENBQUMsQ0FBQztZQUNILHVDQUF3QixDQUFDLElBQUksRUFBRTtnQkFDN0IsSUFB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TyxDQUFDO2dCQUMzQixVQUFVLENBQUMsT0FBTyxDQUFDO2FBQ3BCLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQztJQUNKLENBQUM7SUFsQ0QsNEJBa0NDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQge2V4cGVyaW1lbnRhbCwgc3RyaW5ncywgbm9ybWFsaXplfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQge1xuICBhcHBseSxcbiAgY2hhaW4sXG4gIGV4dGVybmFsU2NoZW1hdGljLFxuICBmaWx0ZXIsXG4gIG1lcmdlV2l0aCxcbiAgbm9vcCxcbiAgUnVsZSxcbiAgU2NoZW1hdGljQ29udGV4dCxcbiAgU2NoZW1hdGljc0V4Y2VwdGlvbixcbiAgdGVtcGxhdGUsXG4gIFRyZWUsXG4gIHVybCxcbn0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L3NjaGVtYXRpY3MnO1xuaW1wb3J0IHtOb2RlUGFja2FnZUluc3RhbGxUYXNrfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcy90YXNrcyc7XG5pbXBvcnQge2dldFdvcmtzcGFjZX0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L2NvbmZpZyc7XG5pbXBvcnQge1NjaGVtYSBhcyBVbml2ZXJzYWxPcHRpb25zfSBmcm9tICcuL3NjaGVtYSc7XG5pbXBvcnQge1xuICBhZGRQYWNrYWdlSnNvbkRlcGVuZGVuY3ksXG4gIE5vZGVEZXBlbmRlbmN5VHlwZSxcbn0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L2RlcGVuZGVuY2llcyc7XG5pbXBvcnQge2dldFByb2plY3R9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS9wcm9qZWN0JztcbmltcG9ydCB7Z2V0UHJvamVjdFRhcmdldHN9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS9wcm9qZWN0LXRhcmdldHMnO1xuaW1wb3J0IHtJbnNlcnRDaGFuZ2V9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS9jaGFuZ2UnO1xuaW1wb3J0IHtcbiAgYWRkU3ltYm9sVG9OZ01vZHVsZU1ldGFkYXRhLFxuICBmaW5kTm9kZXMsXG4gIGluc2VydEFmdGVyTGFzdE9jY3VycmVuY2UsXG4gIGluc2VydEltcG9ydFxufSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvYXN0LXV0aWxzJztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuaW1wb3J0IHtmaW5kQXBwU2VydmVyTW9kdWxlUGF0aCwgZ2VuZXJhdGVFeHBvcnQsIGdldFRzU291cmNlRmlsZSwgZ2V0VHNTb3VyY2VUZXh0fSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7dXBkYXRlV29ya3NwYWNlfSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvd29ya3NwYWNlJztcblxuLy8gVE9ETyhDYWVydXNLYXJ1KTogbWFrZSB0aGVzZSBjb25maWd1cmFibGVcbmNvbnN0IEJST1dTRVJfRElTVCA9ICdkaXN0L2Jyb3dzZXInO1xuY29uc3QgU0VSVkVSX0RJU1QgPSAnZGlzdC9zZXJ2ZXInO1xuXG5mdW5jdGlvbiBnZXRDbGllbnRQcm9qZWN0KFxuICBob3N0OiBUcmVlLCBvcHRpb25zOiBVbml2ZXJzYWxPcHRpb25zLFxuKTogZXhwZXJpbWVudGFsLndvcmtzcGFjZS5Xb3Jrc3BhY2VQcm9qZWN0IHtcbiAgY29uc3Qgd29ya3NwYWNlID0gZ2V0V29ya3NwYWNlKGhvc3QpO1xuICBjb25zdCBjbGllbnRQcm9qZWN0ID0gd29ya3NwYWNlLnByb2plY3RzW29wdGlvbnMuY2xpZW50UHJvamVjdF07XG4gIGlmICghY2xpZW50UHJvamVjdCkge1xuICAgIHRocm93IG5ldyBTY2hlbWF0aWNzRXhjZXB0aW9uKGBDbGllbnQgYXBwICR7b3B0aW9ucy5jbGllbnRQcm9qZWN0fSBub3QgZm91bmQuYCk7XG4gIH1cblxuICByZXR1cm4gY2xpZW50UHJvamVjdDtcbn1cblxuZnVuY3Rpb24gYWRkRGVwZW5kZW5jaWVzQW5kU2NyaXB0cyhvcHRpb25zOiBVbml2ZXJzYWxPcHRpb25zKTogUnVsZSB7XG4gIHJldHVybiAoaG9zdDogVHJlZSkgPT4ge1xuICAgIGFkZFBhY2thZ2VKc29uRGVwZW5kZW5jeShob3N0LCB7XG4gICAgICB0eXBlOiBOb2RlRGVwZW5kZW5jeVR5cGUuRGVmYXVsdCxcbiAgICAgIG5hbWU6ICdAbmd1bml2ZXJzYWwvZXhwcmVzcy1lbmdpbmUnLFxuICAgICAgdmVyc2lvbjogJzAuMC4wLVBMQUNFSE9MREVSJyxcbiAgICB9KTtcbiAgICBhZGRQYWNrYWdlSnNvbkRlcGVuZGVuY3koaG9zdCwge1xuICAgICAgdHlwZTogTm9kZURlcGVuZGVuY3lUeXBlLkRlZmF1bHQsXG4gICAgICBuYW1lOiAnQG5ndW5pdmVyc2FsL21vZHVsZS1tYXAtbmdmYWN0b3J5LWxvYWRlcicsXG4gICAgICB2ZXJzaW9uOiAnMC4wLjAtUExBQ0VIT0xERVInLFxuICAgIH0pO1xuICAgIGFkZFBhY2thZ2VKc29uRGVwZW5kZW5jeShob3N0LCB7XG4gICAgICB0eXBlOiBOb2RlRGVwZW5kZW5jeVR5cGUuRGVmYXVsdCxcbiAgICAgIG5hbWU6ICdleHByZXNzJyxcbiAgICAgIHZlcnNpb246ICdFWFBSRVNTX1ZFUlNJT04nLFxuICAgIH0pO1xuXG4gICAgaWYgKG9wdGlvbnMud2VicGFjaykge1xuICAgICAgYWRkUGFja2FnZUpzb25EZXBlbmRlbmN5KGhvc3QsIHtcbiAgICAgICAgdHlwZTogTm9kZURlcGVuZGVuY3lUeXBlLkRldixcbiAgICAgICAgbmFtZTogJ3RzLWxvYWRlcicsXG4gICAgICAgIHZlcnNpb246ICdeNS4yLjAnLFxuICAgICAgfSk7XG4gICAgICBhZGRQYWNrYWdlSnNvbkRlcGVuZGVuY3koaG9zdCwge1xuICAgICAgICB0eXBlOiBOb2RlRGVwZW5kZW5jeVR5cGUuRGV2LFxuICAgICAgICBuYW1lOiAnd2VicGFjay1jbGknLFxuICAgICAgICB2ZXJzaW9uOiAnXjMuMS4wJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHNlcnZlckZpbGVOYW1lID0gb3B0aW9ucy5zZXJ2ZXJGaWxlTmFtZS5yZXBsYWNlKCcudHMnLCAnJyk7XG4gICAgY29uc3QgcGtnUGF0aCA9ICcvcGFja2FnZS5qc29uJztcbiAgICBjb25zdCBidWZmZXIgPSBob3N0LnJlYWQocGtnUGF0aCk7XG4gICAgaWYgKGJ1ZmZlciA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IFNjaGVtYXRpY3NFeGNlcHRpb24oJ0NvdWxkIG5vdCBmaW5kIHBhY2thZ2UuanNvbicpO1xuICAgIH1cblxuICAgIGNvbnN0IHBrZyA9IEpTT04ucGFyc2UoYnVmZmVyLnRvU3RyaW5nKCkpO1xuXG4gICAgcGtnLnNjcmlwdHNbJ2NvbXBpbGU6c2VydmVyJ10gPSBvcHRpb25zLndlYnBhY2sgP1xuICAgICAgJ3dlYnBhY2sgLS1jb25maWcgd2VicGFjay5zZXJ2ZXIuY29uZmlnLmpzIC0tcHJvZ3Jlc3MgLS1jb2xvcnMnIDpcbiAgICAgIGB0c2MgLXAgJHtzZXJ2ZXJGaWxlTmFtZX0udHNjb25maWcuanNvbmA7XG4gICAgcGtnLnNjcmlwdHNbJ3NlcnZlOnNzciddID0gYG5vZGUgZGlzdC8ke3NlcnZlckZpbGVOYW1lfWA7XG4gICAgcGtnLnNjcmlwdHNbJ2J1aWxkOnNzciddID0gJ25wbSBydW4gYnVpbGQ6Y2xpZW50LWFuZC1zZXJ2ZXItYnVuZGxlcyAmJiBucG0gcnVuIGNvbXBpbGU6c2VydmVyJztcbiAgICBwa2cuc2NyaXB0c1snYnVpbGQ6Y2xpZW50LWFuZC1zZXJ2ZXItYnVuZGxlcyddID1cbiAgICAgIC8vIHRzbGludDpkaXNhYmxlOm1heC1saW5lLWxlbmd0aFxuICAgICAgYG5nIGJ1aWxkIC0tcHJvZCAmJiBuZyBydW4gJHtvcHRpb25zLmNsaWVudFByb2plY3R9OnNlcnZlcjpwcm9kdWN0aW9uIC0tYnVuZGxlRGVwZW5kZW5jaWVzIGFsbGA7XG5cbiAgICBob3N0Lm92ZXJ3cml0ZShwa2dQYXRoLCBKU09OLnN0cmluZ2lmeShwa2csIG51bGwsIDIpKTtcblxuICAgIHJldHVybiBob3N0O1xuICB9O1xufVxuXG5mdW5jdGlvbiB1cGRhdGVDb25maWdGaWxlKG9wdGlvbnM6IFVuaXZlcnNhbE9wdGlvbnMpIHtcbiAgcmV0dXJuIHVwZGF0ZVdvcmtzcGFjZSgod29ya3NwYWNlID0+IHtcbiAgICBjb25zdCBjbGllbnRQcm9qZWN0ID0gd29ya3NwYWNlLnByb2plY3RzLmdldChvcHRpb25zLmNsaWVudFByb2plY3QpO1xuICAgIGlmIChjbGllbnRQcm9qZWN0KSB7XG4gICAgICBjb25zdCBidWlsZFRhcmdldCA9IGNsaWVudFByb2plY3QudGFyZ2V0cy5nZXQoJ2J1aWxkJyk7XG4gICAgICBjb25zdCBzZXJ2ZXJUYXJnZXQgPSBjbGllbnRQcm9qZWN0LnRhcmdldHMuZ2V0KCdzZXJ2ZXInKTtcblxuICAgICAgLy8gV2UgaGF2ZSB0byBjaGVjayBpZiB0aGUgcHJvamVjdCBjb25maWcgaGFzIGEgc2VydmVyIHRhcmdldCwgYmVjYXVzZVxuICAgICAgLy8gaWYgdGhlIFVuaXZlcnNhbCBzdGVwIGluIHRoaXMgc2NoZW1hdGljIGlzbid0IHJ1biwgaXQgY2FuJ3QgYmUgZ3VhcmFudGVlZFxuICAgICAgLy8gdG8gZXhpc3RcbiAgICAgIGlmICghc2VydmVyVGFyZ2V0IHx8ICFidWlsZFRhcmdldCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHNlcnZlclRhcmdldC5vcHRpb25zID0ge1xuICAgICAgICAuLi5zZXJ2ZXJUYXJnZXQub3B0aW9ucyxcbiAgICAgICAgb3V0cHV0UGF0aDogU0VSVkVSX0RJU1QsXG4gICAgICB9O1xuXG4gICAgICBidWlsZFRhcmdldC5vcHRpb25zID0ge1xuICAgICAgICAuLi5idWlsZFRhcmdldC5vcHRpb25zLFxuICAgICAgICBvdXRwdXRQYXRoOiBCUk9XU0VSX0RJU1QsXG4gICAgICB9O1xuICAgIH1cbiAgfSkpO1xufVxuXG5mdW5jdGlvbiBhZGRNb2R1bGVNYXBMb2FkZXIob3B0aW9uczogVW5pdmVyc2FsT3B0aW9ucyk6IFJ1bGUge1xuICByZXR1cm4gKGhvc3Q6IFRyZWUpID0+IHtcbiAgICBjb25zdCBjbGllbnRQcm9qZWN0ID0gZ2V0UHJvamVjdChob3N0LCBvcHRpb25zLmNsaWVudFByb2plY3QpO1xuICAgIGNvbnN0IGNsaWVudFRhcmdldHMgPSBnZXRQcm9qZWN0VGFyZ2V0cyhjbGllbnRQcm9qZWN0KTtcbiAgICBpZiAoIWNsaWVudFRhcmdldHMuc2VydmVyKSB7XG4gICAgICAvLyBJZiB0aGV5IHNraXBwZWQgVW5pdmVyc2FsIHNjaGVtYXRpY3MgYW5kIGRvbid0IGhhdmUgYSBzZXJ2ZXIgdGFyZ2V0LFxuICAgICAgLy8ganVzdCBnZXQgb3V0XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IG1haW5QYXRoID0gbm9ybWFsaXplKCcvJyArIGNsaWVudFRhcmdldHMuc2VydmVyLm9wdGlvbnMubWFpbik7XG4gICAgY29uc3QgYXBwU2VydmVyTW9kdWxlUmVsYXRpdmVQYXRoID0gZmluZEFwcFNlcnZlck1vZHVsZVBhdGgoaG9zdCwgbWFpblBhdGgpO1xuICAgIGNvbnN0IG1vZHVsZVBhdGggPSBub3JtYWxpemUoXG4gICAgICBgLyR7Y2xpZW50UHJvamVjdC5yb290fS9zcmMvJHthcHBTZXJ2ZXJNb2R1bGVSZWxhdGl2ZVBhdGh9LnRzYCk7XG5cbiAgICAvLyBBZGQgdGhlIG1vZHVsZSBtYXAgbG9hZGVyIGltcG9ydFxuICAgIGxldCBtb2R1bGVTb3VyY2UgPSBnZXRUc1NvdXJjZUZpbGUoaG9zdCwgbW9kdWxlUGF0aCk7XG4gICAgY29uc3QgaW1wb3J0TW9kdWxlID0gJ01vZHVsZU1hcExvYWRlck1vZHVsZSc7XG4gICAgY29uc3QgaW1wb3J0UGF0aCA9ICdAbmd1bml2ZXJzYWwvbW9kdWxlLW1hcC1uZ2ZhY3RvcnktbG9hZGVyJztcbiAgICBjb25zdCBtb2R1bGVNYXBJbXBvcnRDaGFuZ2UgPSBpbnNlcnRJbXBvcnQobW9kdWxlU291cmNlLCBtb2R1bGVQYXRoLCBpbXBvcnRNb2R1bGUsXG4gICAgICBpbXBvcnRQYXRoKSBhcyBJbnNlcnRDaGFuZ2U7XG4gICAgaWYgKG1vZHVsZU1hcEltcG9ydENoYW5nZSkge1xuICAgICAgY29uc3QgcmVjb3JkZXIgPSBob3N0LmJlZ2luVXBkYXRlKG1vZHVsZVBhdGgpO1xuICAgICAgcmVjb3JkZXIuaW5zZXJ0TGVmdChtb2R1bGVNYXBJbXBvcnRDaGFuZ2UucG9zLCBtb2R1bGVNYXBJbXBvcnRDaGFuZ2UudG9BZGQpO1xuICAgICAgaG9zdC5jb21taXRVcGRhdGUocmVjb3JkZXIpO1xuICAgIH1cblxuICAgIC8vIEFkZCB0aGUgbW9kdWxlIG1hcCBsb2FkZXIgbW9kdWxlIHRvIHRoZSBpbXBvcnRzXG4gICAgY29uc3QgaW1wb3J0VGV4dCA9ICdNb2R1bGVNYXBMb2FkZXJNb2R1bGUnO1xuICAgIG1vZHVsZVNvdXJjZSA9IGdldFRzU291cmNlRmlsZShob3N0LCBtb2R1bGVQYXRoKTtcbiAgICBjb25zdCBtZXRhZGF0YUNoYW5nZXMgPSBhZGRTeW1ib2xUb05nTW9kdWxlTWV0YWRhdGEoXG4gICAgICBtb2R1bGVTb3VyY2UsIG1vZHVsZVBhdGgsICdpbXBvcnRzJywgaW1wb3J0VGV4dCk7XG4gICAgaWYgKG1ldGFkYXRhQ2hhbmdlcykge1xuICAgICAgY29uc3QgcmVjb3JkZXIgPSBob3N0LmJlZ2luVXBkYXRlKG1vZHVsZVBhdGgpO1xuICAgICAgbWV0YWRhdGFDaGFuZ2VzLmZvckVhY2goKGNoYW5nZTogSW5zZXJ0Q2hhbmdlKSA9PiB7XG4gICAgICAgIHJlY29yZGVyLmluc2VydFJpZ2h0KGNoYW5nZS5wb3MsIGNoYW5nZS50b0FkZCk7XG4gICAgICB9KTtcbiAgICAgIGhvc3QuY29tbWl0VXBkYXRlKHJlY29yZGVyKTtcbiAgICB9XG4gIH07XG59XG5cbmZ1bmN0aW9uIGFkZEV4cG9ydHMob3B0aW9uczogVW5pdmVyc2FsT3B0aW9ucyk6IFJ1bGUge1xuICByZXR1cm4gKGhvc3Q6IFRyZWUpID0+IHtcbiAgICBjb25zdCBjbGllbnRQcm9qZWN0ID0gZ2V0UHJvamVjdChob3N0LCBvcHRpb25zLmNsaWVudFByb2plY3QpO1xuICAgIGNvbnN0IGNsaWVudFRhcmdldHMgPSBnZXRQcm9qZWN0VGFyZ2V0cyhjbGllbnRQcm9qZWN0KTtcblxuICAgIGlmICghY2xpZW50VGFyZ2V0cy5zZXJ2ZXIpIHtcbiAgICAgIC8vIElmIHRoZXkgc2tpcHBlZCBVbml2ZXJzYWwgc2NoZW1hdGljcyBhbmQgZG9uJ3QgaGF2ZSBhIHNlcnZlciB0YXJnZXQsXG4gICAgICAvLyBqdXN0IGdldCBvdXRcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBtYWluUGF0aCA9IG5vcm1hbGl6ZSgnLycgKyBjbGllbnRUYXJnZXRzLnNlcnZlci5vcHRpb25zLm1haW4pO1xuICAgIGNvbnN0IG1haW5Tb3VyY2VGaWxlID0gZ2V0VHNTb3VyY2VGaWxlKGhvc3QsIG1haW5QYXRoKTtcbiAgICBsZXQgbWFpblRleHQgPSBnZXRUc1NvdXJjZVRleHQoaG9zdCwgbWFpblBhdGgpO1xuICAgIGNvbnN0IG1haW5SZWNvcmRlciA9IGhvc3QuYmVnaW5VcGRhdGUobWFpblBhdGgpO1xuICAgIGNvbnN0IGV4cHJlc3NFbmdpbmVFeHBvcnQgPSBnZW5lcmF0ZUV4cG9ydChtYWluU291cmNlRmlsZSwgWyduZ0V4cHJlc3NFbmdpbmUnXSxcbiAgICAgICdAbmd1bml2ZXJzYWwvZXhwcmVzcy1lbmdpbmUnKTtcbiAgICBjb25zdCBtb2R1bGVNYXBFeHBvcnQgPSBnZW5lcmF0ZUV4cG9ydChtYWluU291cmNlRmlsZSwgWydwcm92aWRlTW9kdWxlTWFwJ10sXG4gICAgICAnQG5ndW5pdmVyc2FsL21vZHVsZS1tYXAtbmdmYWN0b3J5LWxvYWRlcicpO1xuICAgIGNvbnN0IGV4cG9ydHMgPSBmaW5kTm9kZXMobWFpblNvdXJjZUZpbGUsIHRzLlN5bnRheEtpbmQuRXhwb3J0RGVjbGFyYXRpb24pO1xuICAgIGNvbnN0IGFkZGVkRXhwb3J0cyA9IGBcXG4ke2V4cHJlc3NFbmdpbmVFeHBvcnR9XFxuJHttb2R1bGVNYXBFeHBvcnR9XFxuYDtcbiAgICBjb25zdCBleHBvcnRDaGFuZ2UgPSBpbnNlcnRBZnRlckxhc3RPY2N1cnJlbmNlKGV4cG9ydHMsIGFkZGVkRXhwb3J0cywgbWFpblRleHQsXG4gICAgICAwKSBhcyBJbnNlcnRDaGFuZ2U7XG5cbiAgICBtYWluUmVjb3JkZXIuaW5zZXJ0TGVmdChleHBvcnRDaGFuZ2UucG9zLCBleHBvcnRDaGFuZ2UudG9BZGQpO1xuICAgIGhvc3QuY29tbWl0VXBkYXRlKG1haW5SZWNvcmRlcik7XG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChvcHRpb25zOiBVbml2ZXJzYWxPcHRpb25zKTogUnVsZSB7XG4gIHJldHVybiAoaG9zdDogVHJlZSwgY29udGV4dDogU2NoZW1hdGljQ29udGV4dCkgPT4ge1xuICAgIGNvbnN0IGNsaWVudFByb2plY3QgPSBnZXRDbGllbnRQcm9qZWN0KGhvc3QsIG9wdGlvbnMpO1xuICAgIGlmIChjbGllbnRQcm9qZWN0LnByb2plY3RUeXBlICE9PSAnYXBwbGljYXRpb24nKSB7XG4gICAgICB0aHJvdyBuZXcgU2NoZW1hdGljc0V4Y2VwdGlvbihgVW5pdmVyc2FsIHJlcXVpcmVzIGEgcHJvamVjdCB0eXBlIG9mIFwiYXBwbGljYXRpb25cIi5gKTtcbiAgICB9XG5cbiAgICBpZiAoIW9wdGlvbnMuc2tpcEluc3RhbGwpIHtcbiAgICAgIGNvbnRleHQuYWRkVGFzayhuZXcgTm9kZVBhY2thZ2VJbnN0YWxsVGFzaygpKTtcbiAgICB9XG5cbiAgICBjb25zdCByb290U291cmNlID0gYXBwbHkodXJsKCcuL2ZpbGVzL3Jvb3QnKSwgW1xuICAgICAgb3B0aW9ucy5za2lwU2VydmVyID8gZmlsdGVyKHBhdGggPT4gIXBhdGguc3RhcnRzV2l0aCgnX19zZXJ2ZXJGaWxlTmFtZScpKSA6IG5vb3AoKSxcbiAgICAgIG9wdGlvbnMud2VicGFjayA/XG4gICAgICAgIGZpbHRlcihwYXRoID0+ICFwYXRoLmluY2x1ZGVzKCd0c2NvbmZpZycpKSA6IGZpbHRlcihwYXRoID0+ICFwYXRoLnN0YXJ0c1dpdGgoJ3dlYnBhY2snKSksXG4gICAgICB0ZW1wbGF0ZSh7XG4gICAgICAgIC4uLnN0cmluZ3MsXG4gICAgICAgIC4uLm9wdGlvbnMgYXMgb2JqZWN0LFxuICAgICAgICBzdHJpcFRzRXh0ZW5zaW9uOiAoczogc3RyaW5nKSA9PiBzLnJlcGxhY2UoL1xcLnRzJC8sICcnKSxcbiAgICAgICAgZ2V0QnJvd3NlckRpc3REaXJlY3Rvcnk6ICgpID0+IEJST1dTRVJfRElTVCxcbiAgICAgICAgZ2V0U2VydmVyRGlzdERpcmVjdG9yeTogKCkgPT4gU0VSVkVSX0RJU1QsXG4gICAgICB9KVxuICAgIF0pO1xuXG4gICAgcmV0dXJuIGNoYWluKFtcbiAgICAgIG9wdGlvbnMuc2tpcFVuaXZlcnNhbCA/XG4gICAgICAgIG5vb3AoKSA6IGV4dGVybmFsU2NoZW1hdGljKCdAc2NoZW1hdGljcy9hbmd1bGFyJywgJ3VuaXZlcnNhbCcsIG9wdGlvbnMpLFxuICAgICAgdXBkYXRlQ29uZmlnRmlsZShvcHRpb25zKSxcbiAgICAgIG1lcmdlV2l0aChyb290U291cmNlKSxcbiAgICAgIGFkZERlcGVuZGVuY2llc0FuZFNjcmlwdHMob3B0aW9ucyksXG4gICAgICBhZGRNb2R1bGVNYXBMb2FkZXIob3B0aW9ucyksXG4gICAgICBhZGRFeHBvcnRzKG9wdGlvbnMpLFxuICAgIF0pO1xuICB9O1xufVxuIl19